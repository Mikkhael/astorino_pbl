<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Test Mqtt</title>
	<!-- Includeing the library -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
</head>
<body>
	
	<img src="" alt="" id="camera_image">


<script>

	const cameraImage = document.getElementById("camera_image"); // Reference to the HTMLImage object

	const mqtt_user = "user";
	const mqtt_pass = "password";
	const mqtt_port = 8080;
	const mqtt_id   = "mqttws_" + Math.floor(Math.random() * 10000000); // Generating a random mqtt client id
	
	const mqtt_url = `ws://${location.hostname}:${mqtt_port}/mqtt`; // Create a URL for MQTT over WebSockets
	const mqttClient = new Paho.MQTT.Client(mqtt_url, mqtt_id);

	mqttClient.connect({
		userName: mqtt_user,
		password: mqtt_pass,
		onSuccess: () => {
			console.log("[MQTT] Connection Success");
			mqttClient.subscribe("img/jpeg");
			mqttClient.subscribe("test");
		},
		onFailure: (err) => {
			console.error("[MQTT] Connection Failed", err);
		}
	});
	mqttClient.onConnectionLost = (err) => {
		console.error("[MQTT] Disconnected", err);
	}
	mqttClient.onMessageArrived = (message) => {
		const topic = message.destinationName;
		if(topic == "test"){
			console.log("Received test message:", message.payloadString);
		}else if(topic == "img/jpeg"){
			console.log("Received new image");
			replaceImage(new Blob([message.payloadBytes]));
		}else{
			console.log(`Unhandled topic:`, topic);
		}
	}


	let currentImageDataUrl = null; // Last bounded URL to the image data Blob
	function replaceImage(newImageData){
		if(currentImageDataUrl){ // Check if image is already bound to a Blob
			URL.revokeObjectURL(currentImageDataUrl); // Free the memory from the old Blob
		}
		currentImageDataUrl = URL.createObjectURL(newImageData) // Bind new Blob to an URL
		cameraImage.src = currentImageDataUrl // Set the image URL to the new Blob
	}

</script>

</body>
</html>